Submitted By: DJ Lucas <dj at linuxfromscratch dot org>
Date: 2010-02-18
Initial Package Version: 4.8.2
Upstream Status: Applied
Origin: Firefox-3.6 source distribution (upstream)
Description: Adds changes from Firefox-3.6 (distributed)

diff -Naur nspr-4.8.2/mozilla/nsprpub/admin/repackage.sh nspr-4.8.3/mozilla-1.9.2/nsprpub/admin/repackage.sh
--- nspr-4.8.2/mozilla/nsprpub/admin/repackage.sh	2009-10-03 19:57:02.000000000 -0500
+++ nspr-4.8.3/mozilla-1.9.2/nsprpub/admin/repackage.sh	2010-01-20 21:30:59.000000000 -0600
@@ -64,10 +64,10 @@
 # 
 # ------------------------------------------------------------------
 
-FROMTOP=/share/builds/components/nspr20/v4.8.2
-TOTOP=./v4.8.2
-NSPRDIR=nspr-4.8.2
-SOURCETAG=NSPR_4_8_2_RTM
+FROMTOP=/share/builds/components/nspr20/v4.8.3
+TOTOP=./v4.8.3
+NSPRDIR=nspr-4.8.3
+SOURCETAG=NSPR_4_8_3_RTM
 
 #
 # enumerate Unix object directories on /s/b/c
diff -Naur nspr-4.8.2/mozilla/nsprpub/config/rules.mk nspr-4.8.3/mozilla-1.9.2/nsprpub/config/rules.mk
--- nspr-4.8.2/mozilla/nsprpub/config/rules.mk	2009-05-01 18:08:01.000000000 -0500
+++ nspr-4.8.3/mozilla-1.9.2/nsprpub/config/rules.mk	2010-01-20 21:30:59.000000000 -0600
@@ -172,18 +172,13 @@
 RELEASE_LIBS_DEST	= $(RELEASE_LIB_DIR)
 endif
 
+define MAKE_IN_DIR
+	$(MAKE) -C $(dir) $@
+
+endef # do not remove the blank line!
+
 ifdef DIRS
-LOOP_OVER_DIRS		=					\
-	@for d in $(DIRS); do					\
-		if test -d $$d; then				\
-			set -e;					\
-			echo "cd $$d; $(MAKE) $@";		\
-			$(MAKE) -C $$d $@;			\
-			set +e;					\
-		else						\
-			echo "Skipping non-directory $$d...";	\
-		fi;						\
-	done
+LOOP_OVER_DIRS = $(foreach dir,$(DIRS),$(MAKE_IN_DIR))
 endif
 
 ################################################################################
@@ -387,9 +382,8 @@
 endif
 
 ifdef NEED_ABSOLUTE_PATH
-PWD := $(shell pwd)
 # The quotes allow absolute paths to contain spaces.
-pr_abspath = "$(if $(findstring :,$(1)),$(1),$(if $(filter /%,$(1)),$(1),$(PWD)/$(1)))"
+pr_abspath = "$(if $(findstring :,$(1)),$(1),$(if $(filter /%,$(1)),$(1),$(CURDIR)/$(1)))"
 endif
 
 $(OBJDIR)/%.$(OBJ_SUFFIX): %.cpp
diff -Naur nspr-4.8.2/mozilla/nsprpub/configure nspr-4.8.3/mozilla-1.9.2/nsprpub/configure
--- nspr-4.8.2/mozilla/nsprpub/configure	2009-10-03 19:57:00.000000000 -0500
+++ nspr-4.8.3/mozilla-1.9.2/nsprpub/configure	2010-01-20 21:30:59.000000000 -0600
@@ -695,7 +695,7 @@
 
 MOD_MAJOR_VERSION=4
 MOD_MINOR_VERSION=8
-MOD_PATCH_VERSION=2
+MOD_PATCH_VERSION=3
 NSPR_MODNAME=nspr20
 _HAVE_PTHREADS=
 USE_PTHREADS=
diff -Naur nspr-4.8.2/mozilla/nsprpub/configure.in nspr-4.8.3/mozilla-1.9.2/nsprpub/configure.in
--- nspr-4.8.2/mozilla/nsprpub/configure.in	2009-10-03 19:57:01.000000000 -0500
+++ nspr-4.8.3/mozilla-1.9.2/nsprpub/configure.in	2010-01-20 21:30:59.000000000 -0600
@@ -50,7 +50,7 @@
 dnl ========================================================
 MOD_MAJOR_VERSION=4
 MOD_MINOR_VERSION=8
-MOD_PATCH_VERSION=2
+MOD_PATCH_VERSION=3
 NSPR_MODNAME=nspr20
 _HAVE_PTHREADS=
 USE_PTHREADS=
diff -Naur nspr-4.8.2/mozilla/nsprpub/pr/include/prinit.h nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/include/prinit.h
--- nspr-4.8.2/mozilla/nsprpub/pr/include/prinit.h	2009-10-05 18:11:26.000000000 -0500
+++ nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/include/prinit.h	2010-01-20 21:30:59.000000000 -0600
@@ -63,10 +63,10 @@
 ** The format of the version string is
 **     "<major version>.<minor version>[.<patch level>] [<Beta>]"
 */
-#define PR_VERSION  "4.8.2"
+#define PR_VERSION  "4.8.3"
 #define PR_VMAJOR   4
 #define PR_VMINOR   8
-#define PR_VPATCH   2
+#define PR_VPATCH   3
 #define PR_BETA     PR_FALSE
 
 /*
diff -Naur nspr-4.8.2/mozilla/nsprpub/pr/src/io/prlog.c nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/src/io/prlog.c
--- nspr-4.8.2/mozilla/nsprpub/pr/src/io/prlog.c	2009-05-12 15:43:10.000000000 -0500
+++ nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/src/io/prlog.c	2010-01-20 21:30:59.000000000 -0600
@@ -456,7 +456,7 @@
         PR_ExplodeTime(PR_Now(), PR_GMTParameters, &now);
         nb_tid = PR_snprintf(line, sizeof(line)-1,
                              "%04d-%02d-%02d %02d:%02d:%02d.%06d UTC - ",
-                             now.tm_year, now.tm_month, now.tm_mday,
+                             now.tm_year, now.tm_month + 1, now.tm_mday,
                              now.tm_hour, now.tm_min, now.tm_sec,
                              now.tm_usec);
     }
diff -Naur nspr-4.8.2/mozilla/nsprpub/pr/src/misc/prdtoa.c nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/src/misc/prdtoa.c
--- nspr-4.8.2/mozilla/nsprpub/pr/src/misc/prdtoa.c	2009-10-05 17:58:41.000000000 -0500
+++ nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/src/misc/prdtoa.c	2010-01-20 21:31:00.000000000 -0600
@@ -1728,6 +1728,8 @@
 			}
 		}
  dig_done:
+	if (nd > 64 * 1024)
+		goto ret0;
 	e = 0;
 	if (c == 'e' || c == 'E') {
 		if (!nd && !nz && !nz0) {
diff -Naur nspr-4.8.2/mozilla/nsprpub/pr/tests/dtoa.c nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/tests/dtoa.c
--- nspr-4.8.2/mozilla/nsprpub/pr/tests/dtoa.c	2009-09-25 19:59:40.000000000 -0500
+++ nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/tests/dtoa.c	2010-01-20 21:31:00.000000000 -0600
@@ -47,6 +47,7 @@
  *
  *****************************************************************************/
 #include <stdio.h>
+#include <stdlib.h>
 #include <sys/types.h>
 #include <string.h>
 #include <locale.h>
@@ -61,6 +62,7 @@
     double num1;
     double zero = 0.0;
     char   cnvt[50];
+    char  *thousands;
     
     num = 1e24;
     num1 = PR_strtod("1e24",NULL);
@@ -195,7 +197,6 @@
         failed_already = 1;
     }
 
-
     num = -1.0000000001e-21;
     num1 = PR_strtod("-1.0000000001e-21",NULL);
     if(num1 != num){
@@ -215,6 +216,26 @@
      */
     num1 = PR_strtod("4e-356",NULL);
 
+    /*
+     * A very long input with ~384K digits.
+     * Bug 516396: Should not crash.
+     * Bug 521306: Should return 0 without converting the input.
+     */
+#define LENGTH (384 * 1024)
+    thousands = (char *)malloc(LENGTH);
+    thousands[0] = '0';
+    thousands[1] = '.';
+    memset(&thousands[2], '1', LENGTH - 3);
+    thousands[LENGTH - 1] = '\0';
+    num = 0;
+    num1 = PR_strtod(thousands,NULL);
+    free(thousands);
+    if(num1 != num){
+        fprintf(stderr,"Failed to convert numeric value %s\n",
+                "0.1111111111111111...");
+        failed_already = 1;
+    }
+
     if (failed_already) {
         printf("FAILED\n");
     } else {
diff -Naur nspr-4.8.2/mozilla/nsprpub/pr/tests/runtests.pl nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/tests/runtests.pl
--- nspr-4.8.2/mozilla/nsprpub/pr/tests/runtests.pl	2009-05-09 16:30:55.000000000 -0500
+++ nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/tests/runtests.pl	2010-01-20 21:31:00.000000000 -0600
@@ -170,7 +170,7 @@
         # No timeout: use blocking wait
         $ret = waitpid($lpid,0);
         # Exit and don't kill
-        $lstatus = $? % 256;
+        $lstatus = $?;
         $ltimeout = -1;
     } else {
         while ($ltimeout > 0) {
diff -Naur nspr-4.8.2/mozilla/nsprpub/pr/tests/vercheck.c nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/tests/vercheck.c
--- nspr-4.8.2/mozilla/nsprpub/pr/tests/vercheck.c	2009-10-03 19:57:03.000000000 -0500
+++ nspr-4.8.3/mozilla-1.9.2/nsprpub/pr/tests/vercheck.c	2010-01-20 21:31:00.000000000 -0600
@@ -52,9 +52,9 @@
 #include <stdlib.h>
 
 /*
- * This release (4.8.2) is backward compatible with the
+ * This release (4.8.3) is backward compatible with the
  * 4.0.x, 4.1.x, 4.2.x, 4.3.x, 4.4.x, 4.5.x, 4.6.x, 4.7.x,
- * 4.8, and 4.8.1 releases.  It, of course, is compatible
+ * 4.8, 4.8.1, and 4.8.2 releases.  It, of course, is compatible
  * with itself.
  */
 static char *compatible_version[] = {
@@ -65,7 +65,7 @@
     "4.6.6", "4.6.7", "4.6.8",
     "4.7", "4.7.1", "4.7.2", "4.7.3", "4.7.4", "4.7.5",
     "4.7.6",
-    "4.8", "4.8.1", PR_VERSION
+    "4.8", "4.8.1", "4.8.2", PR_VERSION
 };
 
 /*
