Submitted By: Robert Connolly <cendres at videotron dot ca> (ashes)
Date: 2003-12-01
Initial Package Version: 2.4.20
Origin: http://www.northernsecurity.net/adamantix/diffs/2.4.20-propolice.patch
Description: Linux kernel patch for ProPolice Stack Gaurd 
http://www.linuxfromscratch.org/hints/downloads/files/propolice.txt
http://www.topside.org/~ashes/files/protector/propolice.txt

diff -uNr linux-2.4.20.orig/include/linux/kernel.h linux-2.4.20.ssp/include/linux/kernel.h
--- linux-2.4.20.orig/include/linux/kernel.h	2002-11-29 00:53:15.000000000 +0100
+++ linux-2.4.20.ssp/include/linux/kernel.h	2003-05-20 00:06:59.000000000 +0200
@@ -86,6 +86,9 @@
 extern void dev_probe_lock(void);
 extern void dev_probe_unlock(void);
 
+extern int __guard;
+extern void __stack_smash_handler(int, char []);
+
 extern int session_of_pgrp(int pgrp);
 
 asmlinkage int printk(const char * fmt, ...)
diff -uNr linux-2.4.20.orig/kernel/ksyms.c linux-2.4.20.ssp/kernel/ksyms.c
--- linux-2.4.20.orig/kernel/ksyms.c	2002-11-29 00:53:15.000000000 +0100
+++ linux-2.4.20.ssp/kernel/ksyms.c	2003-05-20 00:04:34.000000000 +0200
@@ -502,6 +502,8 @@
 EXPORT_SYMBOL(seq_release);
 EXPORT_SYMBOL(seq_read);
 EXPORT_SYMBOL(seq_lseek);
+EXPORT_SYMBOL_NOVERS(__guard);
+EXPORT_SYMBOL_NOVERS(__stack_smash_handler);
 
 /* Program loader interfaces */
 EXPORT_SYMBOL(setup_arg_pages);
diff -uNr linux-2.4.20.orig/lib/Makefile linux-2.4.20.ssp/lib/Makefile
--- linux-2.4.20.orig/lib/Makefile	2002-11-29 00:53:15.000000000 +0100
+++ linux-2.4.20.ssp/lib/Makefile	2003-05-19 23:57:02.000000000 +0200
@@ -11,7 +11,7 @@
 export-objs := cmdline.o dec_and_lock.o rwsem-spinlock.o rwsem.o rbtree.o
 
 obj-y := errno.o ctype.o string.o vsprintf.o brlock.o cmdline.o \
-	 bust_spinlocks.o rbtree.o dump_stack.o
+	 bust_spinlocks.o rbtree.o dump_stack.o propolice.o
 
 obj-$(CONFIG_RWSEM_GENERIC_SPINLOCK) += rwsem-spinlock.o
 obj-$(CONFIG_RWSEM_XCHGADD_ALGORITHM) += rwsem.o
diff -uNr linux-2.4.20.orig/lib/propolice.c linux-2.4.20.ssp/lib/propolice.c
--- linux-2.4.20.orig/lib/propolice.c	1970-01-01 01:00:00.000000000 +0100
+++ linux-2.4.20.ssp/lib/propolice.c	2003-05-20 00:00:37.000000000 +0200
@@ -0,0 +1,13 @@
+ /*
+  *  linux/lib/errno.c
+  *
+  *
+  */
+ 
+ int __guard = '\0\0\n\777';
+ 
+ void __stack_smash_handler (int damaged, char func[])
+ 	 {
+	   static char *message = "propolice detects %x at function %s.\n" ;
+	   panic (message, damaged, func);
+}
